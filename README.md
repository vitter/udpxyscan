# 高性能多线程网络端口扫描器

一个基于C语言开发的高性能多线程网络端口扫描器，支持SYN半开放扫描和TCP连接扫描两种模式。

## 特性

- **双模式扫描**：
  - TCP Connect扫描：使用系统网络API进行连接测试
  - SYN半开放扫描：发送SYN包进行快速端口检测（需要root权限）

- **高性能**：
  - 多线程并发扫描（最多256个线程）
  - 智能批处理和速率控制
  - 优化的网络超时设置

- **灵活的目标定义**：
  - 支持单个IP、IP范围、CIDR格式
  - 支持端口列表和端口范围
  - 支持逗号分隔的多目标

- **专业功能**：
  - UDPXY服务专门检测
  - 详细的调试信息
  - 结果文件输出
  - 静默和快速模式

## 编译

### 基本编译
```bash
make
```

### 调试版本
```bash
make debug
```

### 系统安装（可选）
```bash
sudo make install
```

## 使用方法

### 基本语法
```bash
./portscanner <ip> <start_port> <end_port> [选项]
```

### IP格式支持
```bash
# 单个IP
./portscanner 192.168.1.1 80 443

# IP范围
./portscanner 192.168.1.1-192.168.1.254 22 80

# CIDR格式
./portscanner 192.168.1.0/24 80 443

# 多个IP组合
./portscanner -ip "192.168.1.1,192.168.2.1-192.168.2.10,10.0.0.0/24" -ports "22,80,443,8080"
```

### 扫描模式

#### TCP连接扫描（默认）
```bash
./portscanner 192.168.1.1 1-1000 -mode tcp
```

#### SYN半开放扫描（需要root权限）
```bash
sudo ./portscanner 192.168.1.1 1-1000 -mode syn
```

### 常用选项

| 选项 | 说明 | 默认值 |
|------|------|--------|
| `-ip <list>` | IP地址列表 | 使用位置参数 |
| `-ports <list>` | 端口列表 | 使用位置参数 |
| `-mode <tcp\|syn>` | 扫描模式 | tcp |
| `-t <num>` | 线程数 | 50 |
| `-cto <ms>` | 连接超时(毫秒) | 500 |
| `-rto <ms>` | 接收超时(毫秒) | 2000 |
| `-out <file>` | 输出文件 | 无 |
| `-udpxy` | 启用UDPXY检测 | 关闭 |
| `-v` | 详细模式 | 关闭 |
| `-d` | 调试模式 | 关闭 |
| `-fast` | 快速模式 | 关闭 |
| `-q` | 静默模式 | 关闭 |

### 使用示例

#### 基本端口扫描
```bash
# 扫描单个主机的常用端口
./portscanner 192.168.1.1 1 1000

# 扫描整个网段的SSH端口
./portscanner 192.168.1.0/24 22 22
```

#### UDPXY服务发现
```bash
# 扫描UDPXY服务（常用于IPTV）
./portscanner 192.168.1.0/24 4000 4010 -udpxy -out udpxy_results.txt

# 快速静默UDPXY扫描
./portscanner 192.168.1.0/24 4000 4010 -udpxy -fast -q -out results.txt
```

#### 高级扫描
```bash
# SYN扫描（需要root权限）
sudo ./portscanner 10.0.0.0/8 22,80,443 -mode syn -t 100

# 多IP多端口扫描
./portscanner -ip "192.168.1.1-192.168.1.50,10.0.0.1" -ports "22,80,443,8080" -out scan_results.txt

# 调试模式详细扫描
./portscanner 192.168.1.1 80 443 -d -v
```

## 权限要求

- **TCP Connect扫描**：无特殊权限要求
- **SYN扫描**：需要root权限来创建原始套接字

### 设置SUID（可选，谨慎使用）
```bash
sudo chown root:root portscanner
sudo chmod +s portscanner
```

## 性能调优

### 大规模扫描建议
```bash
# 大网段快速扫描
./portscanner 10.0.0.0/16 80 80 -fast -t 200 -cto 200 -q

# 降低检测率的隐蔽扫描
./portscanner target.com 1-1000 -t 10 -cto 5000
```

### 线程数选择指南
- **小规模扫描**（<100个目标）：10-50线程
- **中等规模扫描**（100-1000个目标）：50-100线程
- **大规模扫描**（>1000个目标）：100-200线程
- **网络受限环境**：10-30线程

## 输出格式

### 控制台输出
```
[+] 192.168.1.1:22 端口开放
[+] 192.168.1.1:80 发现UDPXY服务
[调试] 192.168.1.1:443 TCP连接成功
```

### 文件输出
```
192.168.1.1:22
192.168.1.1:80
192.168.1.100:4000
```

## 技术特性

### 扫描技术
- **TCP Connect**：完整的三次握手连接测试
- **SYN扫描**：半开放扫描，发送SYN包检测端口状态
- **超时控制**：可配置的连接和接收超时
- **并发控制**：智能的线程池和任务队列管理

### 网络优化
- 非阻塞套接字操作
- 连接重用和资源管理
- 自适应的延迟控制
- 批处理任务分发

## 故障排除

### 常见问题

**Q: SYN扫描不工作**
A: 确保以root权限运行，并检查系统是否支持原始套接字

**Q: 扫描速度慢**
A: 尝试使用 `-fast` 选项，或调整 `-t`（线程数）和 `-cto`（超时）参数

**Q: 大量"连接被拒绝"错误**
A: 目标可能有连接限制，尝试减少线程数或增加延迟

**Q: 无法检测到已知开放的端口**
A: 检查防火墙设置，尝试增加超时时间

### 调试技巧
```bash
# 启用详细调试信息
./portscanner target 80 80 -d -v

# 测试单个端口
./portscanner target 80 80 -t 1 -d

# 检查网络连通性
ping target
telnet target 80
```

## 法律声明

此工具仅用于合法的网络安全测试和系统管理目的。使用者有责任确保：

1. 只在拥有授权的网络和系统上使用
2. 遵守当地法律法规
3. 不用于恶意攻击或未授权的网络扫描
4. 注意扫描频率，避免影响目标系统正常运行

## 开发信息

- **语言**：C (POSIX兼容)
- **依赖**：pthread, 标准网络库
- **平台**：Linux, Unix, macOS
- **许可**：MIT License

## 贡献

欢迎提交问题报告和功能请求。在贡献代码时，请确保：

1. 遵循现有的代码风格
2. 添加适当的错误处理
3. 更新相关文档
4. 测试在不同平台上的兼容性

---

**注意**：SYN扫描功能需要原始套接字权限，在某些受限环境中可能无法使用。程序会自动回退到TCP连接扫描模式。
